@page "{handler?}"
@using SaharBeautyWeb.Models.Entities.Banners
@model SaharBeautyWeb.Pages.UserPanels.Admin.SiteSettings.Banners.IndexModel
@{
    Layout = "_UserPanelLayout";
    var a = Model;
}


@Html.AntiForgeryToken()

@* 
@if (!Model.Banner?.IsSuccess ?? false)
{
    <input style="display:none" id="error" value="@Model.Banner.Error" />

} *@
@if (Model.Banner?.IsSuccess == true && Model.Banner?.URL != null)
{
    <div class="d-flex align-items-start">
        <div class="flex-grow-1 overflow-hidden">
            <h5 class="font-size-14 text-truncate">
                <a href="#" class="text-dark">@Model.Banner.Title</a>
            </h5>
            <p class="font-size-13 text-muted mb-0">@Model.Banner.CreateDate</p>
        </div>
        <div class="flex-shrink-0 ms-2">
            <div class="dropdown">
                <a class="btn btn-link text-muted font-size-16 p-1 py-0 dropdown-toggle shadow-none"
                   href="#"
                   role="button"
                   data-bs-toggle="dropdown"
                   aria-expanded="false">
                    <i class="bx bx-dots-horizontal-rounded">

                    </i>
                </a>
            </div>
        </div>
    </div>
    <div class="position-relative mt-3">
        <img src="@Model.Banner.URL" alt="@Model.Banner.ImageName" class="img-thumbnail">
    </div>

    <button type="button"
            class="btn btn-primary waves-effect waves-light"
            id="edit-banner @Model.Banner.Id">
        ویرایش
    </button>
}
else if (Model.Banner?.IsSuccess == true && Model.Banner.URL == null)
{
    <button type="button"
            class="btn btn-primary waves-effect waves-light"
            id="edit-banner ">
        fjghjyj
    </button>
    <partial name="_AddPartial" model="Model.AddBanner" />
}


    @section Scripts {
    <script>

        $(() => {
            var $container = $("#banner-container");
            var $form = $("#register-banner");
            var $displayImage = $("#display-image");
            var $banerShimmer = $("#banner-shimmer");
            var error = $("#error").val();
            if (error != null) {
                showPopup(error);
            }

            // $.ajax({
            //     url: '/UserPanels/Admin/SiteSettings/Banners?handler=Banner',
            //     type: 'GET',
            //     success: function (res) {
            //         if (res.success && res.data) {
            //             var banner = res.data;
            //             $container.html(`
            //                      <div class="d-flex align-items-start">
            //                          <div class="flex-grow-1 overflow-hidden">
            //                              <h5 class="font-size-14 text-truncate">
            //                                  <a href="#" class="text-dark">${banner.title}</a>
            //                              </h5>
            //                              <p class="font-size-13 text-muted mb-0">${banner.createDate}</p>
            //                          </div>
            //                          <div class="flex-shrink-0 ms-2">
            //                              <div class="dropdown">
            //                                  <a class="btn btn-link text-muted font-size-16 p-1 py-0 dropdown-toggle shadow-none"
            //                                     href="#"
            //                                     role="button"
            //                                     data-bs-toggle="dropdown"
            //                                     aria-expanded="false">
            //                                      <i class="bx bx-dots-horizontal-rounded">

            //                                      </i>
            //                                  </a>
            //                                  <ul class="dropdown-menu dropdown-menu-end">
            //                                      <li>
            //                                        <a class="dropdown-item banner-editt" id="banner-${banner.id}" href="#">
            //                                              ویرایش
            //                                         </a>
            //                                      </li>
            //                                  </ul>
            //                              </div>
            //                          </div>
            //                      </div>
            //                      <div class="position-relative mt-3">
            //                          <img src="${banner.url}" alt="${banner.imageName}" class="img-thumbnail">
            //                      </div>

            //                     <button type="button"
            //                             class="btn btn-primary waves-effect waves-light"
            //                             id="edit-banner${banner.id}">
            //                             ویرایش
            //                      </button>`)
            //         } else if (res.success && res.data == null) {
            //             $banerShimmer.hide();
            //             $form.show();
            //         } else {
            //             handleApiError(res);
            //         }
            //     },
            //     error: function () {
            //         $container.html('<p class="text-center text-danger">خطا در بارگذاری بنر</p>');
            //     }
            // })


            $("#createBanner").on("click", function (e) {
                e.preventDefault();

                var title = $("#banner-title").val();
                var imageFile = $("#banner-image")[0].files[0];
                if (!title || !imageFile) {
                 showPopup("عنوان و عکس نباید خالی باشند ")
                return;
                }

                var allowedExtensions = /(\.jpg|\.jpeg|\.png)$/i;
                if (!allowedExtensions.exec(imageFile.name)) {
                    showPopup("فرمت تصویر باید jpg، jpeg یا png باشد.")
                    return;
                }

                let formData = new FormData();
                formData.append("Title", title);
                formData.append("Image", imageFile);

                var token = $('input[name="__RequestVerificationToken"]').val();
                if (token) formData.append('__RequestVerificationToken', token);

                var btn = $(this).prop("disabled", true);
                $.ajax({
                    url: '@Url.Page("Index", "CreateBanner")',
                    type: 'POST',
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function (res) {
                        if (res.success) {
                            location.reload();
                        } else {
                            handleApiError(res);
                            return
                        }
                    },
                    error: function (err) {
                        handleApiError(res);
                        return;
                    }
                });
            });

            $container.on("click", ".banner-editt", function (e) {
                e.preventDefault();

                // فقط برای تست مطمئن شیم کلیک کار میکنه
                console.log("ویرایش کلیک شد");

                // نمایش مودال
                var modal = new bootstrap.Modal(document.getElementById('staticBackdrop'));
                modal.show();
            });
        });

    </script>
    }
